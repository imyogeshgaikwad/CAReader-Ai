<% layout("/layouts/boilerplate") %>

<div class="row mt-3">
  <div class="col-8 offset-2">
    <h3>Edit Listing</h3>
    <form method="POST" action="/listings/<%= listing._id %>?_method=PUT" novalidate class="needs-validation" enctype="multipart/form-data">
      
      <!-- Title -->
      <div class="mb-3">
        <label for="title" class="form-label">Title</label>
        <div class="input-group">
          <input 
            name="listing[title]" 
            type="text" 
            placeholder="Add a catchy title" 
            class="form-control" 
            value="<%= listing.title %>"
            required
          />
          <button 
            type="button" 
            id="generate-titles-btn" 
            class="btn btn-outline-primary"
            onclick="generateTitles()"
            title="Generate AI title suggestions"
          >
            âœ¨ Generate Titles
          </button>
        </div>
        <div class="valid-feedback">Title looks good!</div>
        <div class="invalid-feedback">Title is required.</div>
      </div>

      <!-- Description -->
      <div class="mb-3">
        <label for="description" class="form-label">Description</label>
        <textarea 
          name="listing[description]" 
          class="form-control" 
          rows="5"
          placeholder="Describe your property..."
          required
        ><%= listing.description %></textarea>
        <div class="btn-group mt-2" role="group">
          <button 
            type="button" 
            id="generate-description-btn" 
            class="btn btn-sm btn-primary"
            onclick="generateDescription()"
            title="Generate AI description"
          >
            âœ¨ Generate Description
          </button>
          <button 
            type="button" 
            id="enhance-description-btn" 
            class="btn btn-sm btn-outline-primary"
            onclick="enhanceDescription()"
            title="Enhance existing description with AI"
          >
            âœ¨ Enhance Description
          </button>
        </div>
        <% if (listing.aiGenerated && listing.aiGenerated.description) { %>
          <small class="text-muted d-block mt-1">
            ðŸ¤– AI-generated content (last updated: <%= new Date(listing.aiGenerated.lastUpdated).toLocaleDateString() %>)
          </small>
        <% } %>
        <div class="valid-feedback">Description looks good!</div>
        <div class="invalid-feedback">Description is required.</div>
      </div>

      <!-- Current Image Preview -->
      <div class="mb-3">
        <label class="form-label">Current Image</label>
        <div class="card" style="max-width: 300px;">
          <img src="<%= originalImageUrl %>" class="card-img-top" alt="Current listing image">
          <div class="card-body">
            <% if (listing.aiMetadata && listing.aiMetadata.imageQualityScore) { %>
              <small class="text-muted">
                AI Quality Score: <%= listing.aiMetadata.imageQualityScore %>/10
              </small>
            <% } %>
            <% if (listing.aiMetadata && listing.aiMetadata.imageTags && listing.aiMetadata.imageTags.length > 0) { %>
              <div class="mt-2">
                <small class="text-muted d-block">AI Detected Tags:</small>
                <div class="d-flex flex-wrap gap-1 mt-1">
                  <% listing.aiMetadata.imageTags.forEach(tag => { %>
                    <span class="badge bg-secondary"><%= tag %></span>
                  <% }) %>
                </div>
              </div>
            <% } %>
          </div>
        </div>
      </div>

      <!-- New Image Upload -->
      <div class="mb-3">
        <label for="image" class="form-label">Upload New Image (Optional)</label>
        <input 
          name="listing[image]" 
          type="file" 
          class="form-control" 
          accept="image/*"
        />
        <small class="form-text text-muted">
          ðŸ¤– AI will automatically analyze new images
        </small>
      </div>

      <div class="row">
        <!-- Price -->
        <div class="mb-3 col-md-4">
          <label for="price" class="form-label">Price</label>
          <div class="input-group">
            <span class="input-group-text">$</span>
            <input 
              name="listing[price]" 
              type="number" 
              placeholder="1200" 
              class="form-control"
              value="<%= listing.price %>"
              min="0"
              required
            />
          </div>
          <button 
            type="button" 
            id="predict-price-btn" 
            class="btn btn-sm btn-warning mt-2 w-100"
            onclick="predictPrice()"
            title="Get AI price recommendation"
          >
            ðŸ’° Get Price Recommendation
          </button>
          <% if (listing.aiMetadata && listing.aiMetadata.suggestedPrice) { %>
            <small class="text-muted d-block mt-1">
              AI Suggested: $<%= listing.aiMetadata.suggestedPrice %>
            </small>
          <% } %>
          <div class="valid-feedback">Price looks good!</div>
          <div class="invalid-feedback">Price is required.</div>
        </div>

        <!-- Location -->
        <div class="mb-3 col-md-8">
          <label for="location" class="form-label">Location</label>
          <input 
            name="listing[location]" 
            type="text" 
            placeholder="Jaipur, Rajasthan" 
            class="form-control"
            value="<%= listing.location %>"
            required
          />
          <div class="valid-feedback">Location looks good!</div>
          <div class="invalid-feedback">Location is required.</div>
        </div>
      </div>

      <!-- Country -->
      <div class="mb-3">
        <label for="country" class="form-label">Country</label>
        <input 
          name="listing[country]" 
          type="text" 
          placeholder="India" 
          class="form-control"
          value="<%= listing.country %>"
          required
        />
        <div class="valid-feedback">Country looks good!</div>
        <div class="invalid-feedback">Country is required.</div>
      </div>

      <!-- Hidden field to track AI-generated content -->
      <input type="hidden" name="listing[aiGenerated]" id="aiGeneratedFlag" value="false" />

      <!-- Submit Button -->
      <button class="btn btn-dark edit-btn">Update Listing</button>
    </form>
  </div>
</div>

<script>
  // Form validation
  (function () {
    'use strict'
    var forms = document.querySelectorAll('.needs-validation')
    Array.prototype.slice.call(forms)
      .forEach(function (form) {
        form.addEventListener('submit', function (event) {
          if (!form.checkValidity()) {
            event.preventDefault()
            event.stopPropagation()
          }
          form.classList.add('was-validated')
        }, false)
      })
  })()

  // Track when AI generates content
  function markAsAIGenerated() {
    document.getElementById('aiGeneratedFlag').value = 'true';
  }

  // Override AI functions to mark content
  const originalGenerate = window.generateDescription;
  window.generateDescription = async function() {
    await originalGenerate();
    markAsAIGenerated();
  };
</script>

<script src="/js/aiFeatures.js"></script>

<style>
  .edit-btn {
    width: 100%;
    margin-top: 1rem;
  }

  .btn-group {
    display: flex;
    gap: 0.5rem;
  }

  .card-img-top {
    height: 200px;
    object-fit: cover;
  }

  .badge {
    font-size: 0.7rem;
  }
</style>